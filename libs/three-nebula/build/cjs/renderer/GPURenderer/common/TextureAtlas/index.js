"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _types = require("../../../types");

var _constants = require("./constants");

var _constants2 = require("../../../../constants");

var _potpack = _interopRequireDefault(require("potpack"));

/**
 * Dynamic texture atlas for performant support of systems with multiple emitters and textures.
 *
 */
var TextureAtlas = /*#__PURE__*/function () {
  function TextureAtlas(renderer, shouldDebug) {
    (0, _classCallCheck2["default"])(this, TextureAtlas);
    var THREE = renderer.three,
        rendererType = renderer.type;
    var data = new Float32Array(_constants.DATA_TEXTURE_SIZE * 4);
    var ctx = this.ctx = document.createElement('canvas').getContext('2d');
    var canvas = ctx.canvas;
    this.shouldDebug = shouldDebug;
    this.rendererType = rendererType;
    this.indexData = data;
    this.canvas = canvas;
    this.entries = [];

    if (rendererType === _types.RENDERER_TYPE_GPU_DESKTOP) {
      this.atlasIndex = new THREE.DataTexture(data, _constants.DATA_TEXTURE_SIZE, 1, THREE.RGBAFormat, THREE.FloatType);
    }

    canvas.width = canvas.height = _constants.DATA_TEXTURE_SIZE;

    if (shouldDebug) {
      this.debug(canvas, ctx);
    }

    this.atlasTexture = new THREE.CanvasTexture(canvas);
    this.atlasTexture.flipY = false;
    renderer.material.uniforms.uTexture.value = this.atlasTexture;

    if (rendererType === _types.RENDERER_TYPE_GPU_DESKTOP) {
      renderer.material.uniforms.atlasIndex.value = this.atlasIndex;
    }

    renderer.material.uniformsNeedUpdate = true;
  }
  /**
   * Logs to the console when in dev mode.
   *
   */


  (0, _createClass2["default"])(TextureAtlas, [{
    key: "log",
    value: function log() {
      var _console;

      if (!_constants2.__DEV__) {
        return;
      }

      (_console = console).log.apply(_console, arguments);
    }
    /**
     * Debugs the texture atlas by rendering it to a canvas in the DOM.
     *
     */

  }, {
    key: "debug",
    value: function debug() {
      var canvas = this.canvas,
          ctx = this.ctx;
      var halfmax = canvas.width;
      ctx.fillStyle = 'purple';
      ctx.fillRect(0, 0, halfmax, halfmax);
      ctx.fillStyle = 'green';
      ctx.fillRect(0, halfmax, halfmax, halfmax);
      ctx.fillStyle = 'blue';
      ctx.fillRect(halfmax, 0, halfmax, halfmax);
      ctx.fillStyle = 'orange';
      ctx.fillRect(halfmax, halfmax, halfmax, halfmax);
      ctx.fillStyle = 'yellow';
      ctx.font = canvas.width + 'px Verdana';
      ctx.fillText('top row', 100, 500);
      ctx.fillStyle = 'pink';
      ctx.fillText('bottom row', 100, 1500);
      canvas.style.position = 'absolute';
      canvas.style.width = canvas.style.height = '300px';
      canvas.style.left = canvas.style.top = '0px';
      canvas.style.zIndex = 100;
      document.body.appendChild(canvas);
    }
    /**
     * Adds a texture to the texture atlas and flags that the atlas needs to be updated.
     *
     */

  }, {
    key: "addTexture",
    value: function addTexture(texture) {
      this.log('Adding texture to atlas:', texture.uuid);
      texture.textureIndex = this.entries.length;
      this.entries.push({
        texture: texture
      });
      this.needsUpdate = true;
    }
    /**
     * Updates the texture atlas. Will only rebuild the atlas if all images are loaded.
     *
     */

  }, {
    key: "update",
    value: function update() {
      if (!this.needsUpdate) {
        return;
      }

      var entries = this.entries,
          canvas = this.canvas,
          indexData = this.indexData,
          ctx = this.ctx,
          atlasIndex = this.atlasIndex,
          atlasTexture = this.atlasTexture,
          rendererType = this.rendererType;

      for (var i = 0; i < entries.length; i++) {
        if (!entries[i].texture.image) {
          return;
        }
      }

      this.needsUpdate = false;

      for (var _i = 0; _i < entries.length; _i++) {
        var e = entries[_i];
        var texture = e.texture;
        var _texture$image = texture.image,
            width = _texture$image.width,
            height = _texture$image.height;
        e.w = width;
        e.h = height;
      }

      var stats = (0, _potpack["default"])(entries);
      this.log('Rebuilt atlas:', stats);

      if (canvas.width != stats.w || canvas.height != stats.h) {
        canvas.width = stats.w;
        canvas.height = stats.h;
      }

      for (var _i2 = 0; _i2 < entries.length; _i2++) {
        var _e = this.entries[_i2];
        var ii = _e.texture.textureIndex * 4;

        if (rendererType === _types.RENDERER_TYPE_GPU_DESKTOP) {
          indexData[ii + 0] = _e.x / canvas.width;
          indexData[ii + 1] = _e.y / canvas.height;
          indexData[ii + 2] = (_e.x + _e.w) / canvas.width;
          indexData[ii + 3] = (_e.y + _e.h) / canvas.height;
        }

        if (rendererType === _types.RENDERER_TYPE_GPU_MOBILE) {
          indexData[ii + 0] = _e.x / (canvas.width + 1);
          indexData[ii + 1] = _e.y / (canvas.height + 1);
          indexData[ii + 2] = (_e.x + _e.w) / (canvas.width + 1);
          indexData[ii + 3] = (_e.y + _e.h) / (canvas.height + 1);
        }

        ctx.drawImage(_e.texture.image, _e.x, _e.y, _e.w, _e.h);
      }

      if (rendererType === _types.RENDERER_TYPE_GPU_DESKTOP) {
        atlasIndex.needsUpdate = true;
      }

      atlasTexture.needsUpdate = true;
    }
    /**
     * Disposes of the textures used by the texture atlas.
     *
     * @return void
     */

  }, {
    key: "destroy",
    value: function destroy() {
      var atlasIndex = this.atlasIndex,
          atlasTexture = this.atlasTexture,
          canvas = this.canvas;
      atlasTexture.dispose();
      atlasIndex && atlasIndex.dispose();

      if (this.shouldDebug) {
        canvas.remove();
      }

      this.entries = [];
    }
  }]);
  return TextureAtlas;
}();

exports["default"] = TextureAtlas;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9yZW5kZXJlci9HUFVSZW5kZXJlci9jb21tb24vVGV4dHVyZUF0bGFzL2luZGV4LmpzIl0sIm5hbWVzIjpbIlRleHR1cmVBdGxhcyIsInJlbmRlcmVyIiwic2hvdWxkRGVidWciLCJUSFJFRSIsInRocmVlIiwicmVuZGVyZXJUeXBlIiwidHlwZSIsImRhdGEiLCJGbG9hdDMyQXJyYXkiLCJEQVRBX1RFWFRVUkVfU0laRSIsImN0eCIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsImdldENvbnRleHQiLCJjYW52YXMiLCJpbmRleERhdGEiLCJlbnRyaWVzIiwiUkVOREVSRVJfVFlQRV9HUFVfREVTS1RPUCIsImF0bGFzSW5kZXgiLCJEYXRhVGV4dHVyZSIsIlJHQkFGb3JtYXQiLCJGbG9hdFR5cGUiLCJ3aWR0aCIsImhlaWdodCIsImRlYnVnIiwiYXRsYXNUZXh0dXJlIiwiQ2FudmFzVGV4dHVyZSIsImZsaXBZIiwibWF0ZXJpYWwiLCJ1bmlmb3JtcyIsInVUZXh0dXJlIiwidmFsdWUiLCJ1bmlmb3Jtc05lZWRVcGRhdGUiLCJfX0RFVl9fIiwiY29uc29sZSIsImxvZyIsImhhbGZtYXgiLCJmaWxsU3R5bGUiLCJmaWxsUmVjdCIsImZvbnQiLCJmaWxsVGV4dCIsInN0eWxlIiwicG9zaXRpb24iLCJsZWZ0IiwidG9wIiwiekluZGV4IiwiYm9keSIsImFwcGVuZENoaWxkIiwidGV4dHVyZSIsInV1aWQiLCJ0ZXh0dXJlSW5kZXgiLCJsZW5ndGgiLCJwdXNoIiwibmVlZHNVcGRhdGUiLCJpIiwiaW1hZ2UiLCJlIiwidyIsImgiLCJzdGF0cyIsImlpIiwieCIsInkiLCJSRU5ERVJFUl9UWVBFX0dQVV9NT0JJTEUiLCJkcmF3SW1hZ2UiLCJkaXNwb3NlIiwicmVtb3ZlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBS0E7O0FBQ0E7O0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7SUFDcUJBLFk7QUFDbkIsd0JBQVlDLFFBQVosRUFBc0JDLFdBQXRCLEVBQW1DO0FBQUE7QUFBQSxRQUNsQkMsS0FEa0IsR0FDWUYsUUFEWixDQUN6QkcsS0FEeUI7QUFBQSxRQUNMQyxZQURLLEdBQ1lKLFFBRFosQ0FDWEssSUFEVztBQUVqQyxRQUFNQyxJQUFJLEdBQUcsSUFBSUMsWUFBSixDQUFpQkMsK0JBQW9CLENBQXJDLENBQWI7QUFDQSxRQUFNQyxHQUFHLEdBQUksS0FBS0EsR0FBTCxHQUFXQyxRQUFRLENBQUNDLGFBQVQsQ0FBdUIsUUFBdkIsRUFBaUNDLFVBQWpDLENBQTRDLElBQTVDLENBQXhCO0FBSGlDLFFBSXpCQyxNQUp5QixHQUlkSixHQUpjLENBSXpCSSxNQUp5QjtBQU1qQyxTQUFLWixXQUFMLEdBQW1CQSxXQUFuQjtBQUNBLFNBQUtHLFlBQUwsR0FBb0JBLFlBQXBCO0FBQ0EsU0FBS1UsU0FBTCxHQUFpQlIsSUFBakI7QUFDQSxTQUFLTyxNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLRSxPQUFMLEdBQWUsRUFBZjs7QUFFQSxRQUFJWCxZQUFZLEtBQUtZLGdDQUFyQixFQUFnRDtBQUM5QyxXQUFLQyxVQUFMLEdBQWtCLElBQUlmLEtBQUssQ0FBQ2dCLFdBQVYsQ0FDaEJaLElBRGdCLEVBRWhCRSw0QkFGZ0IsRUFHaEIsQ0FIZ0IsRUFJaEJOLEtBQUssQ0FBQ2lCLFVBSlUsRUFLaEJqQixLQUFLLENBQUNrQixTQUxVLENBQWxCO0FBT0Q7O0FBRURQLElBQUFBLE1BQU0sQ0FBQ1EsS0FBUCxHQUFlUixNQUFNLENBQUNTLE1BQVAsR0FBZ0JkLDRCQUEvQjs7QUFFQSxRQUFJUCxXQUFKLEVBQWlCO0FBQ2YsV0FBS3NCLEtBQUwsQ0FBV1YsTUFBWCxFQUFtQkosR0FBbkI7QUFDRDs7QUFFRCxTQUFLZSxZQUFMLEdBQW9CLElBQUl0QixLQUFLLENBQUN1QixhQUFWLENBQXdCWixNQUF4QixDQUFwQjtBQUNBLFNBQUtXLFlBQUwsQ0FBa0JFLEtBQWxCLEdBQTBCLEtBQTFCO0FBRUExQixJQUFBQSxRQUFRLENBQUMyQixRQUFULENBQWtCQyxRQUFsQixDQUEyQkMsUUFBM0IsQ0FBb0NDLEtBQXBDLEdBQTRDLEtBQUtOLFlBQWpEOztBQUVBLFFBQUlwQixZQUFZLEtBQUtZLGdDQUFyQixFQUFnRDtBQUM5Q2hCLE1BQUFBLFFBQVEsQ0FBQzJCLFFBQVQsQ0FBa0JDLFFBQWxCLENBQTJCWCxVQUEzQixDQUFzQ2EsS0FBdEMsR0FBOEMsS0FBS2IsVUFBbkQ7QUFDRDs7QUFFRGpCLElBQUFBLFFBQVEsQ0FBQzJCLFFBQVQsQ0FBa0JJLGtCQUFsQixHQUF1QyxJQUF2QztBQUNEO0FBRUQ7QUFDRjtBQUNBO0FBQ0E7Ozs7OzBCQUNlO0FBQUE7O0FBQ1gsVUFBSSxDQUFDQyxtQkFBTCxFQUFjO0FBQ1o7QUFDRDs7QUFFRCxrQkFBQUMsT0FBTyxFQUFDQyxHQUFSO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTs7Ozs0QkFDVTtBQUFBLFVBQ0VyQixNQURGLEdBQ2tCLElBRGxCLENBQ0VBLE1BREY7QUFBQSxVQUNVSixHQURWLEdBQ2tCLElBRGxCLENBQ1VBLEdBRFY7QUFFTixVQUFNMEIsT0FBTyxHQUFHdEIsTUFBTSxDQUFDUSxLQUF2QjtBQUVBWixNQUFBQSxHQUFHLENBQUMyQixTQUFKLEdBQWdCLFFBQWhCO0FBQ0EzQixNQUFBQSxHQUFHLENBQUM0QixRQUFKLENBQWEsQ0FBYixFQUFnQixDQUFoQixFQUFtQkYsT0FBbkIsRUFBNEJBLE9BQTVCO0FBQ0ExQixNQUFBQSxHQUFHLENBQUMyQixTQUFKLEdBQWdCLE9BQWhCO0FBQ0EzQixNQUFBQSxHQUFHLENBQUM0QixRQUFKLENBQWEsQ0FBYixFQUFnQkYsT0FBaEIsRUFBeUJBLE9BQXpCLEVBQWtDQSxPQUFsQztBQUNBMUIsTUFBQUEsR0FBRyxDQUFDMkIsU0FBSixHQUFnQixNQUFoQjtBQUNBM0IsTUFBQUEsR0FBRyxDQUFDNEIsUUFBSixDQUFhRixPQUFiLEVBQXNCLENBQXRCLEVBQXlCQSxPQUF6QixFQUFrQ0EsT0FBbEM7QUFDQTFCLE1BQUFBLEdBQUcsQ0FBQzJCLFNBQUosR0FBZ0IsUUFBaEI7QUFDQTNCLE1BQUFBLEdBQUcsQ0FBQzRCLFFBQUosQ0FBYUYsT0FBYixFQUFzQkEsT0FBdEIsRUFBK0JBLE9BQS9CLEVBQXdDQSxPQUF4QztBQUNBMUIsTUFBQUEsR0FBRyxDQUFDMkIsU0FBSixHQUFnQixRQUFoQjtBQUNBM0IsTUFBQUEsR0FBRyxDQUFDNkIsSUFBSixHQUFXekIsTUFBTSxDQUFDUSxLQUFQLEdBQWUsWUFBMUI7QUFDQVosTUFBQUEsR0FBRyxDQUFDOEIsUUFBSixDQUFhLFNBQWIsRUFBd0IsR0FBeEIsRUFBNkIsR0FBN0I7QUFDQTlCLE1BQUFBLEdBQUcsQ0FBQzJCLFNBQUosR0FBZ0IsTUFBaEI7QUFDQTNCLE1BQUFBLEdBQUcsQ0FBQzhCLFFBQUosQ0FBYSxZQUFiLEVBQTJCLEdBQTNCLEVBQWdDLElBQWhDO0FBRUExQixNQUFBQSxNQUFNLENBQUMyQixLQUFQLENBQWFDLFFBQWIsR0FBd0IsVUFBeEI7QUFDQTVCLE1BQUFBLE1BQU0sQ0FBQzJCLEtBQVAsQ0FBYW5CLEtBQWIsR0FBcUJSLE1BQU0sQ0FBQzJCLEtBQVAsQ0FBYWxCLE1BQWIsR0FBc0IsT0FBM0M7QUFDQVQsTUFBQUEsTUFBTSxDQUFDMkIsS0FBUCxDQUFhRSxJQUFiLEdBQW9CN0IsTUFBTSxDQUFDMkIsS0FBUCxDQUFhRyxHQUFiLEdBQW1CLEtBQXZDO0FBQ0E5QixNQUFBQSxNQUFNLENBQUMyQixLQUFQLENBQWFJLE1BQWIsR0FBc0IsR0FBdEI7QUFFQWxDLE1BQUFBLFFBQVEsQ0FBQ21DLElBQVQsQ0FBY0MsV0FBZCxDQUEwQmpDLE1BQTFCO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTs7OzsrQkFDYWtDLE8sRUFBUztBQUNsQixXQUFLYixHQUFMLENBQVMsMEJBQVQsRUFBcUNhLE9BQU8sQ0FBQ0MsSUFBN0M7QUFFQUQsTUFBQUEsT0FBTyxDQUFDRSxZQUFSLEdBQXVCLEtBQUtsQyxPQUFMLENBQWFtQyxNQUFwQztBQUNBLFdBQUtuQyxPQUFMLENBQWFvQyxJQUFiLENBQWtCO0FBQUVKLFFBQUFBLE9BQU8sRUFBRUE7QUFBWCxPQUFsQjtBQUNBLFdBQUtLLFdBQUwsR0FBbUIsSUFBbkI7QUFDRDtBQUVEO0FBQ0Y7QUFDQTtBQUNBOzs7OzZCQUNXO0FBQ1AsVUFBSSxDQUFDLEtBQUtBLFdBQVYsRUFBdUI7QUFDckI7QUFDRDs7QUFITSxVQU1MckMsT0FOSyxHQWFILElBYkcsQ0FNTEEsT0FOSztBQUFBLFVBT0xGLE1BUEssR0FhSCxJQWJHLENBT0xBLE1BUEs7QUFBQSxVQVFMQyxTQVJLLEdBYUgsSUFiRyxDQVFMQSxTQVJLO0FBQUEsVUFTTEwsR0FUSyxHQWFILElBYkcsQ0FTTEEsR0FUSztBQUFBLFVBVUxRLFVBVkssR0FhSCxJQWJHLENBVUxBLFVBVks7QUFBQSxVQVdMTyxZQVhLLEdBYUgsSUFiRyxDQVdMQSxZQVhLO0FBQUEsVUFZTHBCLFlBWkssR0FhSCxJQWJHLENBWUxBLFlBWks7O0FBZVAsV0FBSyxJQUFJaUQsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR3RDLE9BQU8sQ0FBQ21DLE1BQTVCLEVBQW9DRyxDQUFDLEVBQXJDLEVBQXlDO0FBQ3ZDLFlBQUksQ0FBQ3RDLE9BQU8sQ0FBQ3NDLENBQUQsQ0FBUCxDQUFXTixPQUFYLENBQW1CTyxLQUF4QixFQUErQjtBQUM3QjtBQUNEO0FBQ0Y7O0FBRUQsV0FBS0YsV0FBTCxHQUFtQixLQUFuQjs7QUFFQSxXQUFLLElBQUlDLEVBQUMsR0FBRyxDQUFiLEVBQWdCQSxFQUFDLEdBQUd0QyxPQUFPLENBQUNtQyxNQUE1QixFQUFvQ0csRUFBQyxFQUFyQyxFQUF5QztBQUN2QyxZQUFNRSxDQUFDLEdBQUd4QyxPQUFPLENBQUNzQyxFQUFELENBQWpCO0FBRHVDLFlBRS9CTixPQUYrQixHQUVuQlEsQ0FGbUIsQ0FFL0JSLE9BRitCO0FBQUEsNkJBR2JBLE9BQU8sQ0FBQ08sS0FISztBQUFBLFlBRy9CakMsS0FIK0Isa0JBRy9CQSxLQUgrQjtBQUFBLFlBR3hCQyxNQUh3QixrQkFHeEJBLE1BSHdCO0FBS3ZDaUMsUUFBQUEsQ0FBQyxDQUFDQyxDQUFGLEdBQU1uQyxLQUFOO0FBQ0FrQyxRQUFBQSxDQUFDLENBQUNFLENBQUYsR0FBTW5DLE1BQU47QUFDRDs7QUFFRCxVQUFNb0MsS0FBSyxHQUFHLHlCQUFRM0MsT0FBUixDQUFkO0FBRUEsV0FBS21CLEdBQUwsQ0FBUyxnQkFBVCxFQUEyQndCLEtBQTNCOztBQUVBLFVBQUk3QyxNQUFNLENBQUNRLEtBQVAsSUFBZ0JxQyxLQUFLLENBQUNGLENBQXRCLElBQTJCM0MsTUFBTSxDQUFDUyxNQUFQLElBQWlCb0MsS0FBSyxDQUFDRCxDQUF0RCxFQUF5RDtBQUN2RDVDLFFBQUFBLE1BQU0sQ0FBQ1EsS0FBUCxHQUFlcUMsS0FBSyxDQUFDRixDQUFyQjtBQUNBM0MsUUFBQUEsTUFBTSxDQUFDUyxNQUFQLEdBQWdCb0MsS0FBSyxDQUFDRCxDQUF0QjtBQUNEOztBQUVELFdBQUssSUFBSUosR0FBQyxHQUFHLENBQWIsRUFBZ0JBLEdBQUMsR0FBR3RDLE9BQU8sQ0FBQ21DLE1BQTVCLEVBQW9DRyxHQUFDLEVBQXJDLEVBQXlDO0FBQ3ZDLFlBQU1FLEVBQUMsR0FBRyxLQUFLeEMsT0FBTCxDQUFhc0MsR0FBYixDQUFWO0FBQ0EsWUFBTU0sRUFBRSxHQUFHSixFQUFDLENBQUNSLE9BQUYsQ0FBVUUsWUFBVixHQUF5QixDQUFwQzs7QUFFQSxZQUFJN0MsWUFBWSxLQUFLWSxnQ0FBckIsRUFBZ0Q7QUFDOUNGLFVBQUFBLFNBQVMsQ0FBQzZDLEVBQUUsR0FBRyxDQUFOLENBQVQsR0FBb0JKLEVBQUMsQ0FBQ0ssQ0FBRixHQUFNL0MsTUFBTSxDQUFDUSxLQUFqQztBQUNBUCxVQUFBQSxTQUFTLENBQUM2QyxFQUFFLEdBQUcsQ0FBTixDQUFULEdBQW9CSixFQUFDLENBQUNNLENBQUYsR0FBTWhELE1BQU0sQ0FBQ1MsTUFBakM7QUFDQVIsVUFBQUEsU0FBUyxDQUFDNkMsRUFBRSxHQUFHLENBQU4sQ0FBVCxHQUFvQixDQUFDSixFQUFDLENBQUNLLENBQUYsR0FBTUwsRUFBQyxDQUFDQyxDQUFULElBQWMzQyxNQUFNLENBQUNRLEtBQXpDO0FBQ0FQLFVBQUFBLFNBQVMsQ0FBQzZDLEVBQUUsR0FBRyxDQUFOLENBQVQsR0FBb0IsQ0FBQ0osRUFBQyxDQUFDTSxDQUFGLEdBQU1OLEVBQUMsQ0FBQ0UsQ0FBVCxJQUFjNUMsTUFBTSxDQUFDUyxNQUF6QztBQUNEOztBQUVELFlBQUlsQixZQUFZLEtBQUswRCwrQkFBckIsRUFBK0M7QUFDN0NoRCxVQUFBQSxTQUFTLENBQUM2QyxFQUFFLEdBQUcsQ0FBTixDQUFULEdBQW9CSixFQUFDLENBQUNLLENBQUYsSUFBTy9DLE1BQU0sQ0FBQ1EsS0FBUCxHQUFlLENBQXRCLENBQXBCO0FBQ0FQLFVBQUFBLFNBQVMsQ0FBQzZDLEVBQUUsR0FBRyxDQUFOLENBQVQsR0FBb0JKLEVBQUMsQ0FBQ00sQ0FBRixJQUFPaEQsTUFBTSxDQUFDUyxNQUFQLEdBQWdCLENBQXZCLENBQXBCO0FBQ0FSLFVBQUFBLFNBQVMsQ0FBQzZDLEVBQUUsR0FBRyxDQUFOLENBQVQsR0FBb0IsQ0FBQ0osRUFBQyxDQUFDSyxDQUFGLEdBQU1MLEVBQUMsQ0FBQ0MsQ0FBVCxLQUFlM0MsTUFBTSxDQUFDUSxLQUFQLEdBQWUsQ0FBOUIsQ0FBcEI7QUFDQVAsVUFBQUEsU0FBUyxDQUFDNkMsRUFBRSxHQUFHLENBQU4sQ0FBVCxHQUFvQixDQUFDSixFQUFDLENBQUNNLENBQUYsR0FBTU4sRUFBQyxDQUFDRSxDQUFULEtBQWU1QyxNQUFNLENBQUNTLE1BQVAsR0FBZ0IsQ0FBL0IsQ0FBcEI7QUFDRDs7QUFFRGIsUUFBQUEsR0FBRyxDQUFDc0QsU0FBSixDQUFjUixFQUFDLENBQUNSLE9BQUYsQ0FBVU8sS0FBeEIsRUFBK0JDLEVBQUMsQ0FBQ0ssQ0FBakMsRUFBb0NMLEVBQUMsQ0FBQ00sQ0FBdEMsRUFBeUNOLEVBQUMsQ0FBQ0MsQ0FBM0MsRUFBOENELEVBQUMsQ0FBQ0UsQ0FBaEQ7QUFDRDs7QUFFRCxVQUFJckQsWUFBWSxLQUFLWSxnQ0FBckIsRUFBZ0Q7QUFDOUNDLFFBQUFBLFVBQVUsQ0FBQ21DLFdBQVgsR0FBeUIsSUFBekI7QUFDRDs7QUFFRDVCLE1BQUFBLFlBQVksQ0FBQzRCLFdBQWIsR0FBMkIsSUFBM0I7QUFDRDtBQUVEO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7Ozs7OEJBQ1k7QUFBQSxVQUNBbkMsVUFEQSxHQUNxQyxJQURyQyxDQUNBQSxVQURBO0FBQUEsVUFDWU8sWUFEWixHQUNxQyxJQURyQyxDQUNZQSxZQURaO0FBQUEsVUFDMEJYLE1BRDFCLEdBQ3FDLElBRHJDLENBQzBCQSxNQUQxQjtBQUdSVyxNQUFBQSxZQUFZLENBQUN3QyxPQUFiO0FBQ0EvQyxNQUFBQSxVQUFVLElBQUlBLFVBQVUsQ0FBQytDLE9BQVgsRUFBZDs7QUFFQSxVQUFJLEtBQUsvRCxXQUFULEVBQXNCO0FBQ3BCWSxRQUFBQSxNQUFNLENBQUNvRCxNQUFQO0FBQ0Q7O0FBRUQsV0FBS2xELE9BQUwsR0FBZSxFQUFmO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBSRU5ERVJFUl9UWVBFX0dQVV9ERVNLVE9QLFxuICBSRU5ERVJFUl9UWVBFX0dQVV9NT0JJTEUsXG59IGZyb20gJy4uLy4uLy4uL3R5cGVzJztcblxuaW1wb3J0IHsgREFUQV9URVhUVVJFX1NJWkUgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBfX0RFVl9fIH0gZnJvbSAnLi4vLi4vLi4vLi4vY29uc3RhbnRzJztcbmltcG9ydCBwb3RwYWNrIGZyb20gJ3BvdHBhY2snO1xuXG4vKipcbiAqIER5bmFtaWMgdGV4dHVyZSBhdGxhcyBmb3IgcGVyZm9ybWFudCBzdXBwb3J0IG9mIHN5c3RlbXMgd2l0aCBtdWx0aXBsZSBlbWl0dGVycyBhbmQgdGV4dHVyZXMuXG4gKlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUZXh0dXJlQXRsYXMge1xuICBjb25zdHJ1Y3RvcihyZW5kZXJlciwgc2hvdWxkRGVidWcpIHtcbiAgICBjb25zdCB7IHRocmVlOiBUSFJFRSwgdHlwZTogcmVuZGVyZXJUeXBlIH0gPSByZW5kZXJlcjtcbiAgICBjb25zdCBkYXRhID0gbmV3IEZsb2F0MzJBcnJheShEQVRBX1RFWFRVUkVfU0laRSAqIDQpO1xuICAgIGNvbnN0IGN0eCA9ICh0aGlzLmN0eCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLmdldENvbnRleHQoJzJkJykpO1xuICAgIGNvbnN0IHsgY2FudmFzIH0gPSBjdHg7XG5cbiAgICB0aGlzLnNob3VsZERlYnVnID0gc2hvdWxkRGVidWc7XG4gICAgdGhpcy5yZW5kZXJlclR5cGUgPSByZW5kZXJlclR5cGU7XG4gICAgdGhpcy5pbmRleERhdGEgPSBkYXRhO1xuICAgIHRoaXMuY2FudmFzID0gY2FudmFzO1xuICAgIHRoaXMuZW50cmllcyA9IFtdO1xuXG4gICAgaWYgKHJlbmRlcmVyVHlwZSA9PT0gUkVOREVSRVJfVFlQRV9HUFVfREVTS1RPUCkge1xuICAgICAgdGhpcy5hdGxhc0luZGV4ID0gbmV3IFRIUkVFLkRhdGFUZXh0dXJlKFxuICAgICAgICBkYXRhLFxuICAgICAgICBEQVRBX1RFWFRVUkVfU0laRSxcbiAgICAgICAgMSxcbiAgICAgICAgVEhSRUUuUkdCQUZvcm1hdCxcbiAgICAgICAgVEhSRUUuRmxvYXRUeXBlXG4gICAgICApO1xuICAgIH1cblxuICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy5oZWlnaHQgPSBEQVRBX1RFWFRVUkVfU0laRTtcblxuICAgIGlmIChzaG91bGREZWJ1Zykge1xuICAgICAgdGhpcy5kZWJ1ZyhjYW52YXMsIGN0eCk7XG4gICAgfVxuXG4gICAgdGhpcy5hdGxhc1RleHR1cmUgPSBuZXcgVEhSRUUuQ2FudmFzVGV4dHVyZShjYW52YXMpO1xuICAgIHRoaXMuYXRsYXNUZXh0dXJlLmZsaXBZID0gZmFsc2U7XG5cbiAgICByZW5kZXJlci5tYXRlcmlhbC51bmlmb3Jtcy51VGV4dHVyZS52YWx1ZSA9IHRoaXMuYXRsYXNUZXh0dXJlO1xuXG4gICAgaWYgKHJlbmRlcmVyVHlwZSA9PT0gUkVOREVSRVJfVFlQRV9HUFVfREVTS1RPUCkge1xuICAgICAgcmVuZGVyZXIubWF0ZXJpYWwudW5pZm9ybXMuYXRsYXNJbmRleC52YWx1ZSA9IHRoaXMuYXRsYXNJbmRleDtcbiAgICB9XG5cbiAgICByZW5kZXJlci5tYXRlcmlhbC51bmlmb3Jtc05lZWRVcGRhdGUgPSB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIExvZ3MgdG8gdGhlIGNvbnNvbGUgd2hlbiBpbiBkZXYgbW9kZS5cbiAgICpcbiAgICovXG4gIGxvZyguLi5hcmdzKSB7XG4gICAgaWYgKCFfX0RFVl9fKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coLi4uYXJncyk7XG4gIH1cblxuICAvKipcbiAgICogRGVidWdzIHRoZSB0ZXh0dXJlIGF0bGFzIGJ5IHJlbmRlcmluZyBpdCB0byBhIGNhbnZhcyBpbiB0aGUgRE9NLlxuICAgKlxuICAgKi9cbiAgZGVidWcoKSB7XG4gICAgY29uc3QgeyBjYW52YXMsIGN0eCB9ID0gdGhpcztcbiAgICBjb25zdCBoYWxmbWF4ID0gY2FudmFzLndpZHRoO1xuXG4gICAgY3R4LmZpbGxTdHlsZSA9ICdwdXJwbGUnO1xuICAgIGN0eC5maWxsUmVjdCgwLCAwLCBoYWxmbWF4LCBoYWxmbWF4KTtcbiAgICBjdHguZmlsbFN0eWxlID0gJ2dyZWVuJztcbiAgICBjdHguZmlsbFJlY3QoMCwgaGFsZm1heCwgaGFsZm1heCwgaGFsZm1heCk7XG4gICAgY3R4LmZpbGxTdHlsZSA9ICdibHVlJztcbiAgICBjdHguZmlsbFJlY3QoaGFsZm1heCwgMCwgaGFsZm1heCwgaGFsZm1heCk7XG4gICAgY3R4LmZpbGxTdHlsZSA9ICdvcmFuZ2UnO1xuICAgIGN0eC5maWxsUmVjdChoYWxmbWF4LCBoYWxmbWF4LCBoYWxmbWF4LCBoYWxmbWF4KTtcbiAgICBjdHguZmlsbFN0eWxlID0gJ3llbGxvdyc7XG4gICAgY3R4LmZvbnQgPSBjYW52YXMud2lkdGggKyAncHggVmVyZGFuYSc7XG4gICAgY3R4LmZpbGxUZXh0KCd0b3Agcm93JywgMTAwLCA1MDApO1xuICAgIGN0eC5maWxsU3R5bGUgPSAncGluayc7XG4gICAgY3R4LmZpbGxUZXh0KCdib3R0b20gcm93JywgMTAwLCAxNTAwKTtcblxuICAgIGNhbnZhcy5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7XG4gICAgY2FudmFzLnN0eWxlLndpZHRoID0gY2FudmFzLnN0eWxlLmhlaWdodCA9ICczMDBweCc7XG4gICAgY2FudmFzLnN0eWxlLmxlZnQgPSBjYW52YXMuc3R5bGUudG9wID0gJzBweCc7XG4gICAgY2FudmFzLnN0eWxlLnpJbmRleCA9IDEwMDtcblxuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoY2FudmFzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGEgdGV4dHVyZSB0byB0aGUgdGV4dHVyZSBhdGxhcyBhbmQgZmxhZ3MgdGhhdCB0aGUgYXRsYXMgbmVlZHMgdG8gYmUgdXBkYXRlZC5cbiAgICpcbiAgICovXG4gIGFkZFRleHR1cmUodGV4dHVyZSkge1xuICAgIHRoaXMubG9nKCdBZGRpbmcgdGV4dHVyZSB0byBhdGxhczonLCB0ZXh0dXJlLnV1aWQpO1xuXG4gICAgdGV4dHVyZS50ZXh0dXJlSW5kZXggPSB0aGlzLmVudHJpZXMubGVuZ3RoO1xuICAgIHRoaXMuZW50cmllcy5wdXNoKHsgdGV4dHVyZTogdGV4dHVyZSB9KTtcbiAgICB0aGlzLm5lZWRzVXBkYXRlID0gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIHRoZSB0ZXh0dXJlIGF0bGFzLiBXaWxsIG9ubHkgcmVidWlsZCB0aGUgYXRsYXMgaWYgYWxsIGltYWdlcyBhcmUgbG9hZGVkLlxuICAgKlxuICAgKi9cbiAgdXBkYXRlKCkge1xuICAgIGlmICghdGhpcy5uZWVkc1VwZGF0ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIGVudHJpZXMsXG4gICAgICBjYW52YXMsXG4gICAgICBpbmRleERhdGEsXG4gICAgICBjdHgsXG4gICAgICBhdGxhc0luZGV4LFxuICAgICAgYXRsYXNUZXh0dXJlLFxuICAgICAgcmVuZGVyZXJUeXBlLFxuICAgIH0gPSB0aGlzO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbnRyaWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoIWVudHJpZXNbaV0udGV4dHVyZS5pbWFnZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5uZWVkc1VwZGF0ZSA9IGZhbHNlO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbnRyaWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBlID0gZW50cmllc1tpXTtcbiAgICAgIGNvbnN0IHsgdGV4dHVyZSB9ID0gZTtcbiAgICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gdGV4dHVyZS5pbWFnZTtcblxuICAgICAgZS53ID0gd2lkdGg7XG4gICAgICBlLmggPSBoZWlnaHQ7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhdHMgPSBwb3RwYWNrKGVudHJpZXMpO1xuXG4gICAgdGhpcy5sb2coJ1JlYnVpbHQgYXRsYXM6Jywgc3RhdHMpO1xuXG4gICAgaWYgKGNhbnZhcy53aWR0aCAhPSBzdGF0cy53IHx8IGNhbnZhcy5oZWlnaHQgIT0gc3RhdHMuaCkge1xuICAgICAgY2FudmFzLndpZHRoID0gc3RhdHMudztcbiAgICAgIGNhbnZhcy5oZWlnaHQgPSBzdGF0cy5oO1xuICAgIH1cblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZW50cmllcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgZSA9IHRoaXMuZW50cmllc1tpXTtcbiAgICAgIGNvbnN0IGlpID0gZS50ZXh0dXJlLnRleHR1cmVJbmRleCAqIDQ7XG5cbiAgICAgIGlmIChyZW5kZXJlclR5cGUgPT09IFJFTkRFUkVSX1RZUEVfR1BVX0RFU0tUT1ApIHtcbiAgICAgICAgaW5kZXhEYXRhW2lpICsgMF0gPSBlLnggLyBjYW52YXMud2lkdGg7XG4gICAgICAgIGluZGV4RGF0YVtpaSArIDFdID0gZS55IC8gY2FudmFzLmhlaWdodDtcbiAgICAgICAgaW5kZXhEYXRhW2lpICsgMl0gPSAoZS54ICsgZS53KSAvIGNhbnZhcy53aWR0aDtcbiAgICAgICAgaW5kZXhEYXRhW2lpICsgM10gPSAoZS55ICsgZS5oKSAvIGNhbnZhcy5oZWlnaHQ7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZW5kZXJlclR5cGUgPT09IFJFTkRFUkVSX1RZUEVfR1BVX01PQklMRSkge1xuICAgICAgICBpbmRleERhdGFbaWkgKyAwXSA9IGUueCAvIChjYW52YXMud2lkdGggKyAxKTtcbiAgICAgICAgaW5kZXhEYXRhW2lpICsgMV0gPSBlLnkgLyAoY2FudmFzLmhlaWdodCArIDEpO1xuICAgICAgICBpbmRleERhdGFbaWkgKyAyXSA9IChlLnggKyBlLncpIC8gKGNhbnZhcy53aWR0aCArIDEpO1xuICAgICAgICBpbmRleERhdGFbaWkgKyAzXSA9IChlLnkgKyBlLmgpIC8gKGNhbnZhcy5oZWlnaHQgKyAxKTtcbiAgICAgIH1cblxuICAgICAgY3R4LmRyYXdJbWFnZShlLnRleHR1cmUuaW1hZ2UsIGUueCwgZS55LCBlLncsIGUuaCk7XG4gICAgfVxuXG4gICAgaWYgKHJlbmRlcmVyVHlwZSA9PT0gUkVOREVSRVJfVFlQRV9HUFVfREVTS1RPUCkge1xuICAgICAgYXRsYXNJbmRleC5uZWVkc1VwZGF0ZSA9IHRydWU7XG4gICAgfVxuXG4gICAgYXRsYXNUZXh0dXJlLm5lZWRzVXBkYXRlID0gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEaXNwb3NlcyBvZiB0aGUgdGV4dHVyZXMgdXNlZCBieSB0aGUgdGV4dHVyZSBhdGxhcy5cbiAgICpcbiAgICogQHJldHVybiB2b2lkXG4gICAqL1xuICBkZXN0cm95KCkge1xuICAgIGNvbnN0IHsgYXRsYXNJbmRleCwgYXRsYXNUZXh0dXJlLCBjYW52YXMgfSA9IHRoaXM7XG5cbiAgICBhdGxhc1RleHR1cmUuZGlzcG9zZSgpO1xuICAgIGF0bGFzSW5kZXggJiYgYXRsYXNJbmRleC5kaXNwb3NlKCk7XG5cbiAgICBpZiAodGhpcy5zaG91bGREZWJ1Zykge1xuICAgICAgY2FudmFzLnJlbW92ZSgpO1xuICAgIH1cblxuICAgIHRoaXMuZW50cmllcyA9IFtdO1xuICB9XG59XG4iXX0=