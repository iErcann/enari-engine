"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _constants = require("./constants");

/**
 * @exports Debug - methods and helpers for debugging System emitters, zones and particles.
 * @requires THREE - { SphereGeometry, BoxGeometry, MeshBasicMaterial, OctahedronGeometry, Mesh }
 */
var _default = {
  /**
   * Adds an event listener to the system instance's SYSTEM_UPDATE event.
   *
   * @param {System} system - the system instance
   * @param {function} onSystemUpdated - the function to call when system has been updated
   * @return {Debug}
   */
  addEventListener: function addEventListener(system, onSystemUpdated) {
    system.eventDispatcher.addEventListener('SYSTEM_UPDATE', onSystemUpdated);
    return this;
  },

  /**
   * Draws a wireframe mesh around the zone for debugging purposes.
   *
   * @param {System} system - the system instance
   * @param {object} container - a three Object3D (usually the scene)
   * @param {Zone} zone - a Zone instance
   * @return void
   */
  drawZone: function drawZone(THREE, system, container) {
    var zone = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};
    var color = '#2194ce';
    var wireframe = true;
    var _zone$width = zone.width,
        width = _zone$width === void 0 ? _constants.DEFAULT_SIZE : _zone$width,
        _zone$height = zone.height,
        height = _zone$height === void 0 ? _constants.DEFAULT_SIZE : _zone$height,
        _zone$depth = zone.depth,
        depth = _zone$depth === void 0 ? _constants.DEFAULT_SIZE : _zone$depth,
        _zone$radius = zone.radius,
        radius = _zone$radius === void 0 ? _constants.DEFAULT_SIZE : _zone$radius,
        _zone$x = zone.x,
        x = _zone$x === void 0 ? _constants.DEFAULT_POSITION : _zone$x,
        _zone$y = zone.y,
        y = _zone$y === void 0 ? _constants.DEFAULT_POSITION : _zone$y,
        _zone$z = zone.z,
        z = _zone$z === void 0 ? _constants.DEFAULT_POSITION : _zone$z;
    var geometry;

    if (zone.isPointZone()) {
      geometry = new THREE.SphereGeometry(15);
    }

    if (zone.isLineZone()) {// TODO
    }

    if (zone.isBoxZone()) {
      geometry = new THREE.BoxGeometry(width, height, depth);
    }

    if (zone.isSphereZone()) {
      geometry = new THREE.SphereGeometry(radius, _constants.DEFAULT_SIZE, _constants.DEFAULT_SIZE);
    }

    if (zone.isMeshZone()) {
      geometry = zone.geometry.geometry ? zone.geometry.geometry.clone() : zone.geometry.clone();
    }

    if (!geometry) {
      geometry = new THREE.BoxGeometry(width, height, depth);
    }

    var material = new THREE.MeshBasicMaterial({
      color: color,
      wireframe: wireframe
    }); // NOTE! geometry.clone is required for UNKNOWN reasons,
    // three does not render the mesh correctly without doing this since r88

    var mesh = new THREE.Mesh(geometry.clone(), material);
    container.add(mesh);
    this.addEventListener(system, function () {
      mesh.position.set(x, y, z);
    });
  },

  /**
   * Draws a mesh for each particle emitted in order to help debug particles.
   *
   * @param {object} system - the system instance
   * @param {object} container - a three Object3D (usually the scene)
   * @param {object} emitter - the emitter to debug
   * @param {string} color - the color for the debug mesh material
   * @return void
   */
  drawEmitter: function drawEmitter(THREE, system, container, emitter, color) {
    var geometry = new THREE.OctahedronGeometry(_constants.DEFAULT_SIZE);
    var material = new THREE.MeshBasicMaterial({
      color: color || '#aaa',
      wireframe: true
    }); // NOTE! geometry.clone is required for UNKNOWN reasons,
    // three does not render the mesh correctly without doing this since r88

    var mesh = new THREE.Mesh(geometry.clone(), material);
    container.add(mesh);
    this.addEventListener(system, function () {
      mesh.position.copy(emitter.position);
      mesh.rotation.set(emitter.rotation.x, emitter.rotation.y, emitter.rotation.z);
    });
  },

  /**
   * Renders emitter / particle information into the info element.
   *
   * @param {object} system - the system instance
   * @param {integer} style - style to apply (see the addInfo method's switch statement)
   * @return void
   */
  renderInfo: function () {
    function getCreatedNumber(type, system) {
      var pool = type == 'material' ? '_materialPool' : '_targetPool';
      var renderer = system.renderers[0];
      return renderer[pool].cID;
    }

    function getEmitterPos(system) {
      var e = system.emitters[0];
      return Math.round(e.p.x) + ',' + Math.round(e.p.y) + ',' + Math.round(e.p.z);
    }

    return function (system, style) {
      this.addInfo(style);
      var str = '';

      switch (this._infoType) {
        case 2:
          str += 'emitter:' + system.emitters.length + '<br>';
          str += 'em speed:' + system.emitters[0].cID + '<br>';
          str += 'pos:' + getEmitterPos(system);
          break;

        case 3:
          str += system.renderers[0].name + '<br>';
          str += 'target:' + getCreatedNumber('target') + '<br>';
          str += 'material:' + getCreatedNumber('material');
          break;

        default:
          str += 'particles:' + system.getCount() + '<br>';
          str += 'pool:' + system.pool.getCount() + '<br>';
          str += 'total:' + (system.getCount() + system.pool.getCount());
      }

      this._infoCon.innerHTML = str;
    };
  }(),

  /**
   * Appends the info element into the dom.
   *
   * @param {integer} style - the style type to apply
   * @return void
   */
  addInfo: function () {
    return function (style) {
      var self = this;

      if (!this._infoCon) {
        this._infoCon = document.createElement('div');
        this._infoCon.style.cssText = ['position:fixed;bottom:0px;left:0;cursor:pointer;', 'opacity:0.9;z-index:10000;padding:10px;font-size:12px;', 'width:120px;height:50px;background-color:#002;color:#0ff;'].join('');
        this._infoType = 1;

        this._infoCon.addEventListener('click', function () {
          self._infoType++;
          if (self._infoType > 3) self._infoType = 1;
        }, false);

        var bg, color;

        switch (style) {
          case 2:
            bg = '#201';
            color = '#f08';
            break;

          case 3:
            bg = '#020';
            color = '#0f0';
            break;

          default:
            bg = '#002';
            color = '#0ff';
        }

        this._infoCon.style['background-color'] = bg;
        this._infoCon.style['color'] = color;
      }

      if (!this._infoCon.parentNode) document.body.appendChild(this._infoCon);
    };
  }()
};
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kZWJ1Zy9EZWJ1Zy5qcyJdLCJuYW1lcyI6WyJhZGRFdmVudExpc3RlbmVyIiwic3lzdGVtIiwib25TeXN0ZW1VcGRhdGVkIiwiZXZlbnREaXNwYXRjaGVyIiwiZHJhd1pvbmUiLCJUSFJFRSIsImNvbnRhaW5lciIsInpvbmUiLCJjb2xvciIsIndpcmVmcmFtZSIsIndpZHRoIiwic2l6ZSIsImhlaWdodCIsImRlcHRoIiwicmFkaXVzIiwieCIsIkRFRkFVTFRfUE9TSVRJT04iLCJ5IiwieiIsImdlb21ldHJ5IiwiaXNQb2ludFpvbmUiLCJTcGhlcmVHZW9tZXRyeSIsImlzTGluZVpvbmUiLCJpc0JveFpvbmUiLCJCb3hHZW9tZXRyeSIsImlzU3BoZXJlWm9uZSIsImlzTWVzaFpvbmUiLCJjbG9uZSIsIm1hdGVyaWFsIiwiTWVzaEJhc2ljTWF0ZXJpYWwiLCJtZXNoIiwiTWVzaCIsImFkZCIsInBvc2l0aW9uIiwic2V0IiwiZHJhd0VtaXR0ZXIiLCJlbWl0dGVyIiwiT2N0YWhlZHJvbkdlb21ldHJ5IiwiY29weSIsInJvdGF0aW9uIiwicmVuZGVySW5mbyIsImdldENyZWF0ZWROdW1iZXIiLCJ0eXBlIiwicG9vbCIsInJlbmRlcmVyIiwicmVuZGVyZXJzIiwiY0lEIiwiZ2V0RW1pdHRlclBvcyIsImUiLCJlbWl0dGVycyIsIk1hdGgiLCJyb3VuZCIsInAiLCJzdHlsZSIsImFkZEluZm8iLCJzdHIiLCJfaW5mb1R5cGUiLCJsZW5ndGgiLCJuYW1lIiwiZ2V0Q291bnQiLCJfaW5mb0NvbiIsImlubmVySFRNTCIsInNlbGYiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJjc3NUZXh0Iiwiam9pbiIsImJnIiwicGFyZW50Tm9kZSIsImJvZHkiLCJhcHBlbmRDaGlsZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO2VBQ2U7QUFDYjtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNFQSxF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NEIsQ0FJdkIsRUFKdUIsQ0FBOUI7QUFNQSxhQUFLVixTQUFMLEdBQWlCLENBQWpCOztBQUNBLGFBQUtJLFFBQUwsQ0FBYzVELGdCQUFkLENBQ0UsT0FERixFQUVFLFlBQVc7QUFDVDhELFVBQUFBLElBQUksQ0FBQ04sU0FBTDtBQUNBLGNBQUlNLElBQUksQ0FBQ04sU0FBTCxHQUFpQixDQUFyQixFQUF3Qk0sSUFBSSxDQUFDTixTQUFMLEdBQWlCLENBQWpCO0FBQ3pCLFNBTEgsRUFNRSxLQU5GOztBQVNBLFlBQUlXLEVBQUosRUFBUTNELEtBQVI7O0FBRUEsZ0JBQVE2QyxLQUFSO0FBQ0UsZUFBSyxDQUFMO0FBQ0VjLFlBQUFBLEVBQUUsR0FBRyxNQUFMO0FBQ0EzRCxZQUFBQSxLQUFLLEdBQUcsTUFBUjtBQUNBOztBQUVGLGVBQUssQ0FBTDtBQUNFMkQsWUFBQUEsRUFBRSxHQUFHLE1BQUw7QUFDQTNELFlBQUFBLEtBQUssR0FBRyxNQUFSO0FBQ0E7O0FBRUY7QUFDRTJELFlBQUFBLEVBQUUsR0FBRyxNQUFMO0FBQ0EzRCxZQUFBQSxLQUFLLEdBQUcsTUFBUjtBQWJKOztBQWdCQSxhQUFLb0QsUUFBTCxDQUFjUCxLQUFkLENBQW9CLGtCQUFwQixJQUEwQ2MsRUFBMUM7QUFDQSxhQUFLUCxRQUFMLENBQWNQLEtBQWQsQ0FBb0IsT0FBcEIsSUFBK0I3QyxLQUEvQjtBQUNEOztBQUVELFVBQUksQ0FBQyxLQUFLb0QsUUFBTCxDQUFjUSxVQUFuQixFQUErQkwsUUFBUSxDQUFDTSxJQUFULENBQWNDLFdBQWQsQ0FBMEIsS0FBS1YsUUFBL0I7QUFDaEMsS0E1Q0Q7QUE2Q0QsR0E5Q1E7QUFqS0ksQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERFRkFVTFRfUE9TSVRJT04sIERFRkFVTFRfU0laRSBhcyBzaXplIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG4vKipcbiAqIEBleHBvcnRzIERlYnVnIC0gbWV0aG9kcyBhbmQgaGVscGVycyBmb3IgZGVidWdnaW5nIFN5c3RlbSBlbWl0dGVycywgem9uZXMgYW5kIHBhcnRpY2xlcy5cbiAqIEByZXF1aXJlcyBUSFJFRSAtIHsgU3BoZXJlR2VvbWV0cnksIEJveEdlb21ldHJ5LCBNZXNoQmFzaWNNYXRlcmlhbCwgT2N0YWhlZHJvbkdlb21ldHJ5LCBNZXNoIH1cbiAqL1xuZXhwb3J0IGRlZmF1bHQge1xuICAvKipcbiAgICogQWRkcyBhbiBldmVudCBsaXN0ZW5lciB0byB0aGUgc3lzdGVtIGluc3RhbmNlJ3MgU1lTVEVNX1VQREFURSBldmVudC5cbiAgICpcbiAgICogQHBhcmFtIHtTeXN0ZW19IHN5c3RlbSAtIHRoZSBzeXN0ZW0gaW5zdGFuY2VcbiAgICogQHBhcmFtIHtmdW5jdGlvbn0gb25TeXN0ZW1VcGRhdGVkIC0gdGhlIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiBzeXN0ZW0gaGFzIGJlZW4gdXBkYXRlZFxuICAgKiBAcmV0dXJuIHtEZWJ1Z31cbiAgICovXG4gIGFkZEV2ZW50TGlzdGVuZXI6IGZ1bmN0aW9uKHN5c3RlbSwgb25TeXN0ZW1VcGRhdGVkKSB7XG4gICAgc3lzdGVtLmV2ZW50RGlzcGF0Y2hlci5hZGRFdmVudExpc3RlbmVyKCdTWVNURU1fVVBEQVRFJywgb25TeXN0ZW1VcGRhdGVkKTtcblxuICAgIHJldHVybiB0aGlzO1xuICB9LFxuXG4gIC8qKlxuICAgKiBEcmF3cyBhIHdpcmVmcmFtZSBtZXNoIGFyb3VuZCB0aGUgem9uZSBmb3IgZGVidWdnaW5nIHB1cnBvc2VzLlxuICAgKlxuICAgKiBAcGFyYW0ge1N5c3RlbX0gc3lzdGVtIC0gdGhlIHN5c3RlbSBpbnN0YW5jZVxuICAgKiBAcGFyYW0ge29iamVjdH0gY29udGFpbmVyIC0gYSB0aHJlZSBPYmplY3QzRCAodXN1YWxseSB0aGUgc2NlbmUpXG4gICAqIEBwYXJhbSB7Wm9uZX0gem9uZSAtIGEgWm9uZSBpbnN0YW5jZVxuICAgKiBAcmV0dXJuIHZvaWRcbiAgICovXG4gIGRyYXdab25lOiBmdW5jdGlvbihUSFJFRSwgc3lzdGVtLCBjb250YWluZXIsIHpvbmUgPSB7fSkge1xuICAgIGNvbnN0IGNvbG9yID0gJyMyMTk0Y2UnO1xuICAgIGNvbnN0IHdpcmVmcmFtZSA9IHRydWU7XG4gICAgY29uc3Qge1xuICAgICAgd2lkdGggPSBzaXplLFxuICAgICAgaGVpZ2h0ID0gc2l6ZSxcbiAgICAgIGRlcHRoID0gc2l6ZSxcbiAgICAgIHJhZGl1cyA9IHNpemUsXG4gICAgICB4ID0gREVGQVVMVF9QT1NJVElPTixcbiAgICAgIHkgPSBERUZBVUxUX1BPU0lUSU9OLFxuICAgICAgeiA9IERFRkFVTFRfUE9TSVRJT04sXG4gICAgfSA9IHpvbmU7XG5cbiAgICBsZXQgZ2VvbWV0cnk7XG5cbiAgICBpZiAoem9uZS5pc1BvaW50Wm9uZSgpKSB7XG4gICAgICBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSgxNSk7XG4gICAgfVxuXG4gICAgaWYgKHpvbmUuaXNMaW5lWm9uZSgpKSB7XG4gICAgICAvLyBUT0RPXG4gICAgfVxuXG4gICAgaWYgKHpvbmUuaXNCb3hab25lKCkpIHtcbiAgICAgIGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KHdpZHRoLCBoZWlnaHQsIGRlcHRoKTtcbiAgICB9XG5cbiAgICBpZiAoem9uZS5pc1NwaGVyZVpvbmUoKSkge1xuICAgICAgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuU3BoZXJlR2VvbWV0cnkocmFkaXVzLCBzaXplLCBzaXplKTtcbiAgICB9XG5cbiAgICBpZiAoem9uZS5pc01lc2hab25lKCkpIHtcbiAgICAgIGdlb21ldHJ5ID0gem9uZS5nZW9tZXRyeS5nZW9tZXRyeVxuICAgICAgICA/IHpvbmUuZ2VvbWV0cnkuZ2VvbWV0cnkuY2xvbmUoKVxuICAgICAgICA6IHpvbmUuZ2VvbWV0cnkuY2xvbmUoKTtcbiAgICB9XG5cbiAgICBpZiAoIWdlb21ldHJ5KSB7XG4gICAgICBnZW9tZXRyeSA9IG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSh3aWR0aCwgaGVpZ2h0LCBkZXB0aCk7XG4gICAgfVxuXG4gICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvciwgd2lyZWZyYW1lIH0pO1xuICAgIC8vIE5PVEUhIGdlb21ldHJ5LmNsb25lIGlzIHJlcXVpcmVkIGZvciBVTktOT1dOIHJlYXNvbnMsXG4gICAgLy8gdGhyZWUgZG9lcyBub3QgcmVuZGVyIHRoZSBtZXNoIGNvcnJlY3RseSB3aXRob3V0IGRvaW5nIHRoaXMgc2luY2Ugcjg4XG4gICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LmNsb25lKCksIG1hdGVyaWFsKTtcblxuICAgIGNvbnRhaW5lci5hZGQobWVzaCk7XG5cbiAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoc3lzdGVtLCBmdW5jdGlvbigpIHtcbiAgICAgIG1lc2gucG9zaXRpb24uc2V0KHgsIHksIHopO1xuICAgIH0pO1xuICB9LFxuXG4gIC8qKlxuICAgKiBEcmF3cyBhIG1lc2ggZm9yIGVhY2ggcGFydGljbGUgZW1pdHRlZCBpbiBvcmRlciB0byBoZWxwIGRlYnVnIHBhcnRpY2xlcy5cbiAgICpcbiAgICogQHBhcmFtIHtvYmplY3R9IHN5c3RlbSAtIHRoZSBzeXN0ZW0gaW5zdGFuY2VcbiAgICogQHBhcmFtIHtvYmplY3R9IGNvbnRhaW5lciAtIGEgdGhyZWUgT2JqZWN0M0QgKHVzdWFsbHkgdGhlIHNjZW5lKVxuICAgKiBAcGFyYW0ge29iamVjdH0gZW1pdHRlciAtIHRoZSBlbWl0dGVyIHRvIGRlYnVnXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb2xvciAtIHRoZSBjb2xvciBmb3IgdGhlIGRlYnVnIG1lc2ggbWF0ZXJpYWxcbiAgICogQHJldHVybiB2b2lkXG4gICAqL1xuICBkcmF3RW1pdHRlcjogZnVuY3Rpb24oVEhSRUUsIHN5c3RlbSwgY29udGFpbmVyLCBlbWl0dGVyLCBjb2xvcikge1xuICAgIGNvbnN0IGdlb21ldHJ5ID0gbmV3IFRIUkVFLk9jdGFoZWRyb25HZW9tZXRyeShzaXplKTtcbiAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7XG4gICAgICBjb2xvcjogY29sb3IgfHwgJyNhYWEnLFxuICAgICAgd2lyZWZyYW1lOiB0cnVlLFxuICAgIH0pO1xuICAgIC8vIE5PVEUhIGdlb21ldHJ5LmNsb25lIGlzIHJlcXVpcmVkIGZvciBVTktOT1dOIHJlYXNvbnMsXG4gICAgLy8gdGhyZWUgZG9lcyBub3QgcmVuZGVyIHRoZSBtZXNoIGNvcnJlY3RseSB3aXRob3V0IGRvaW5nIHRoaXMgc2luY2Ugcjg4XG4gICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKGdlb21ldHJ5LmNsb25lKCksIG1hdGVyaWFsKTtcblxuICAgIGNvbnRhaW5lci5hZGQobWVzaCk7XG5cbiAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoc3lzdGVtLCBmdW5jdGlvbigpIHtcbiAgICAgIG1lc2gucG9zaXRpb24uY29weShlbWl0dGVyLnBvc2l0aW9uKTtcbiAgICAgIG1lc2gucm90YXRpb24uc2V0KFxuICAgICAgICBlbWl0dGVyLnJvdGF0aW9uLngsXG4gICAgICAgIGVtaXR0ZXIucm90YXRpb24ueSxcbiAgICAgICAgZW1pdHRlci5yb3RhdGlvbi56XG4gICAgICApO1xuICAgIH0pO1xuICB9LFxuXG4gIC8qKlxuICAgKiBSZW5kZXJzIGVtaXR0ZXIgLyBwYXJ0aWNsZSBpbmZvcm1hdGlvbiBpbnRvIHRoZSBpbmZvIGVsZW1lbnQuXG4gICAqXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBzeXN0ZW0gLSB0aGUgc3lzdGVtIGluc3RhbmNlXG4gICAqIEBwYXJhbSB7aW50ZWdlcn0gc3R5bGUgLSBzdHlsZSB0byBhcHBseSAoc2VlIHRoZSBhZGRJbmZvIG1ldGhvZCdzIHN3aXRjaCBzdGF0ZW1lbnQpXG4gICAqIEByZXR1cm4gdm9pZFxuICAgKi9cbiAgcmVuZGVySW5mbzogKGZ1bmN0aW9uKCkge1xuICAgIGZ1bmN0aW9uIGdldENyZWF0ZWROdW1iZXIodHlwZSwgc3lzdGVtKSB7XG4gICAgICB2YXIgcG9vbCA9IHR5cGUgPT0gJ21hdGVyaWFsJyA/ICdfbWF0ZXJpYWxQb29sJyA6ICdfdGFyZ2V0UG9vbCc7XG4gICAgICB2YXIgcmVuZGVyZXIgPSBzeXN0ZW0ucmVuZGVyZXJzWzBdO1xuXG4gICAgICByZXR1cm4gcmVuZGVyZXJbcG9vbF0uY0lEO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldEVtaXR0ZXJQb3Moc3lzdGVtKSB7XG4gICAgICB2YXIgZSA9IHN5c3RlbS5lbWl0dGVyc1swXTtcblxuICAgICAgcmV0dXJuIChcbiAgICAgICAgTWF0aC5yb3VuZChlLnAueCkgKyAnLCcgKyBNYXRoLnJvdW5kKGUucC55KSArICcsJyArIE1hdGgucm91bmQoZS5wLnopXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBmdW5jdGlvbihzeXN0ZW0sIHN0eWxlKSB7XG4gICAgICB0aGlzLmFkZEluZm8oc3R5bGUpO1xuICAgICAgdmFyIHN0ciA9ICcnO1xuXG4gICAgICBzd2l0Y2ggKHRoaXMuX2luZm9UeXBlKSB7XG4gICAgICAgIGNhc2UgMjpcbiAgICAgICAgICBzdHIgKz0gJ2VtaXR0ZXI6JyArIHN5c3RlbS5lbWl0dGVycy5sZW5ndGggKyAnPGJyPic7XG4gICAgICAgICAgc3RyICs9ICdlbSBzcGVlZDonICsgc3lzdGVtLmVtaXR0ZXJzWzBdLmNJRCArICc8YnI+JztcbiAgICAgICAgICBzdHIgKz0gJ3BvczonICsgZ2V0RW1pdHRlclBvcyhzeXN0ZW0pO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgMzpcbiAgICAgICAgICBzdHIgKz0gc3lzdGVtLnJlbmRlcmVyc1swXS5uYW1lICsgJzxicj4nO1xuICAgICAgICAgIHN0ciArPSAndGFyZ2V0OicgKyBnZXRDcmVhdGVkTnVtYmVyKCd0YXJnZXQnKSArICc8YnI+JztcbiAgICAgICAgICBzdHIgKz0gJ21hdGVyaWFsOicgKyBnZXRDcmVhdGVkTnVtYmVyKCdtYXRlcmlhbCcpO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgc3RyICs9ICdwYXJ0aWNsZXM6JyArIHN5c3RlbS5nZXRDb3VudCgpICsgJzxicj4nO1xuICAgICAgICAgIHN0ciArPSAncG9vbDonICsgc3lzdGVtLnBvb2wuZ2V0Q291bnQoKSArICc8YnI+JztcbiAgICAgICAgICBzdHIgKz0gJ3RvdGFsOicgKyAoc3lzdGVtLmdldENvdW50KCkgKyBzeXN0ZW0ucG9vbC5nZXRDb3VudCgpKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX2luZm9Db24uaW5uZXJIVE1MID0gc3RyO1xuICAgIH07XG4gIH0pKCksXG5cbiAgLyoqXG4gICAqIEFwcGVuZHMgdGhlIGluZm8gZWxlbWVudCBpbnRvIHRoZSBkb20uXG4gICAqXG4gICAqIEBwYXJhbSB7aW50ZWdlcn0gc3R5bGUgLSB0aGUgc3R5bGUgdHlwZSB0byBhcHBseVxuICAgKiBAcmV0dXJuIHZvaWRcbiAgICovXG4gIGFkZEluZm86IChmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24oc3R5bGUpIHtcbiAgICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgICAgaWYgKCF0aGlzLl9pbmZvQ29uKSB7XG4gICAgICAgIHRoaXMuX2luZm9Db24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgdGhpcy5faW5mb0Nvbi5zdHlsZS5jc3NUZXh0ID0gW1xuICAgICAgICAgICdwb3NpdGlvbjpmaXhlZDtib3R0b206MHB4O2xlZnQ6MDtjdXJzb3I6cG9pbnRlcjsnLFxuICAgICAgICAgICdvcGFjaXR5OjAuOTt6LWluZGV4OjEwMDAwO3BhZGRpbmc6MTBweDtmb250LXNpemU6MTJweDsnLFxuICAgICAgICAgICd3aWR0aDoxMjBweDtoZWlnaHQ6NTBweDtiYWNrZ3JvdW5kLWNvbG9yOiMwMDI7Y29sb3I6IzBmZjsnLFxuICAgICAgICBdLmpvaW4oJycpO1xuXG4gICAgICAgIHRoaXMuX2luZm9UeXBlID0gMTtcbiAgICAgICAgdGhpcy5faW5mb0Nvbi5hZGRFdmVudExpc3RlbmVyKFxuICAgICAgICAgICdjbGljaycsXG4gICAgICAgICAgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBzZWxmLl9pbmZvVHlwZSsrO1xuICAgICAgICAgICAgaWYgKHNlbGYuX2luZm9UeXBlID4gMykgc2VsZi5faW5mb1R5cGUgPSAxO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgZmFsc2VcbiAgICAgICAgKTtcblxuICAgICAgICB2YXIgYmcsIGNvbG9yO1xuXG4gICAgICAgIHN3aXRjaCAoc3R5bGUpIHtcbiAgICAgICAgICBjYXNlIDI6XG4gICAgICAgICAgICBiZyA9ICcjMjAxJztcbiAgICAgICAgICAgIGNvbG9yID0gJyNmMDgnO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICBjYXNlIDM6XG4gICAgICAgICAgICBiZyA9ICcjMDIwJztcbiAgICAgICAgICAgIGNvbG9yID0gJyMwZjAnO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgYmcgPSAnIzAwMic7XG4gICAgICAgICAgICBjb2xvciA9ICcjMGZmJztcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2luZm9Db24uc3R5bGVbJ2JhY2tncm91bmQtY29sb3InXSA9IGJnO1xuICAgICAgICB0aGlzLl9pbmZvQ29uLnN0eWxlWydjb2xvciddID0gY29sb3I7XG4gICAgICB9XG5cbiAgICAgIGlmICghdGhpcy5faW5mb0Nvbi5wYXJlbnROb2RlKSBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMuX2luZm9Db24pO1xuICAgIH07XG4gIH0pKCksXG59O1xuIl19