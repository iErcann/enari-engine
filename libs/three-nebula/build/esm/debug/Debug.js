import { DEFAULT_POSITION, DEFAULT_SIZE as size } from './constants';
/**
 * @exports Debug - methods and helpers for debugging System emitters, zones and particles.
 * @requires THREE - { SphereGeometry, BoxGeometry, MeshBasicMaterial, OctahedronGeometry, Mesh }
 */

export default {
  /**
   * Adds an event listener to the system instance's SYSTEM_UPDATE event.
   *
   * @param {System} system - the system instance
   * @param {function} onSystemUpdated - the function to call when system has been updated
   * @return {Debug}
   */
  addEventListener: function (system, onSystemUpdated) {
    system.eventDispatcher.addEventListener('SYSTEM_UPDATE', onSystemUpdated);
    return this;
  },

  /**
   * Draws a wireframe mesh around the zone for debugging purposes.
   *
   * @param {System} system - the system instance
   * @param {object} container - a three Object3D (usually the scene)
   * @param {Zone} zone - a Zone instance
   * @return void
   */
  drawZone: function (THREE, system, container, zone = {}) {
    const color = '#2194ce';
    const wireframe = true;
    const {
      width = size,
      height = size,
      depth = size,
      radius = size,
      x = DEFAULT_POSITION,
      y = DEFAULT_POSITION,
      z = DEFAULT_POSITION
    } = zone;
    let geometry;

    if (zone.isPointZone()) {
      geometry = new THREE.SphereGeometry(15);
    }

    if (zone.isLineZone()) {// TODO
    }

    if (zone.isBoxZone()) {
      geometry = new THREE.BoxGeometry(width, height, depth);
    }

    if (zone.isSphereZone()) {
      geometry = new THREE.SphereGeometry(radius, size, size);
    }

    if (zone.isMeshZone()) {
      geometry = zone.geometry.geometry ? zone.geometry.geometry.clone() : zone.geometry.clone();
    }

    if (!geometry) {
      geometry = new THREE.BoxGeometry(width, height, depth);
    }

    const material = new THREE.MeshBasicMaterial({
      color,
      wireframe
    }); // NOTE! geometry.clone is required for UNKNOWN reasons,
    // three does not render the mesh correctly without doing this since r88

    const mesh = new THREE.Mesh(geometry.clone(), material);
    container.add(mesh);
    this.addEventListener(system, function () {
      mesh.position.set(x, y, z);
    });
  },

  /**
   * Draws a mesh for each particle emitted in order to help debug particles.
   *
   * @param {object} system - the system instance
   * @param {object} container - a three Object3D (usually the scene)
   * @param {object} emitter - the emitter to debug
   * @param {string} color - the color for the debug mesh material
   * @return void
   */
  drawEmitter: function (THREE, system, container, emitter, color) {
    const geometry = new THREE.OctahedronGeometry(size);
    const material = new THREE.MeshBasicMaterial({
      color: color || '#aaa',
      wireframe: true
    }); // NOTE! geometry.clone is required for UNKNOWN reasons,
    // three does not render the mesh correctly without doing this since r88

    const mesh = new THREE.Mesh(geometry.clone(), material);
    container.add(mesh);
    this.addEventListener(system, function () {
      mesh.position.copy(emitter.position);
      mesh.rotation.set(emitter.rotation.x, emitter.rotation.y, emitter.rotation.z);
    });
  },

  /**
   * Renders emitter / particle information into the info element.
   *
   * @param {object} system - the system instance
   * @param {integer} style - style to apply (see the addInfo method's switch statement)
   * @return void
   */
  renderInfo: function () {
    function getCreatedNumber(type, system) {
      var pool = type == 'material' ? '_materialPool' : '_targetPool';
      var renderer = system.renderers[0];
      return renderer[pool].cID;
    }

    function getEmitterPos(system) {
      var e = system.emitters[0];
      return Math.round(e.p.x) + ',' + Math.round(e.p.y) + ',' + Math.round(e.p.z);
    }

    return function (system, style) {
      this.addInfo(style);
      var str = '';

      switch (this._infoType) {
        case 2:
          str += 'emitter:' + system.emitters.length + '<br>';
          str += 'em speed:' + system.emitters[0].cID + '<br>';
          str += 'pos:' + getEmitterPos(system);
          break;

        case 3:
          str += system.renderers[0].name + '<br>';
          str += 'target:' + getCreatedNumber('target') + '<br>';
          str += 'material:' + getCreatedNumber('material');
          break;

        default:
          str += 'particles:' + system.getCount() + '<br>';
          str += 'pool:' + system.pool.getCount() + '<br>';
          str += 'total:' + (system.getCount() + system.pool.getCount());
      }

      this._infoCon.innerHTML = str;
    };
  }(),

  /**
   * Appends the info element into the dom.
   *
   * @param {integer} style - the style type to apply
   * @return void
   */
  addInfo: function () {
    return function (style) {
      var self = this;

      if (!this._infoCon) {
        this._infoCon = document.createElement('div');
        this._infoCon.style.cssText = ['position:fixed;bottom:0px;left:0;cursor:pointer;', 'opacity:0.9;z-index:10000;padding:10px;font-size:12px;', 'width:120px;height:50px;background-color:#002;color:#0ff;'].join('');
        this._infoType = 1;

        this._infoCon.addEventListener('click', function () {
          self._infoType++;
          if (self._infoType > 3) self._infoType = 1;
        }, false);

        var bg, color;

        switch (style) {
          case 2:
            bg = '#201';
            color = '#f08';
            break;

          case 3:
            bg = '#020';
            color = '#0f0';
            break;

          default:
            bg = '#002';
            color = '#0ff';
        }

        this._infoCon.style['background-color'] = bg;
        this._infoCon.style['color'] = color;
      }

      if (!this._infoCon.parentNode) document.body.appendChild(this._infoCon);
    };
  }()
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kZWJ1Zy9EZWJ1Zy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1BPU0lUSU9OIiwiREVGQVVMVF9TSVpFIiwic2l6ZSIsImFkZEV2ZW50TGlzdGVuZXIiLCJzeXN0ZW0iLCJvblN5c3RlbVVwZGF0ZWQiLCJldmVudERpc3BhdGNoZXIiLCJkcmF3Wm9uZSIsIlRIUkVFIiwiY29udGFpbmVyIiwiem9uZSIsImNvbG9yIiwid2lyZWZyYW1lIiwid2lkdGgiLCJoZWlnaHQiLCJkZXB0aCIsInJhZGl1cyIsIngiLCJ5IiwieiIsImdlb21ldHJ5IiwiaXNQb2ludFpvbmUiLCJTcGhlcmVHZW9tZXRyeSIsImlzTGluZVpvbmUiLCJpc0JveFpvbmUiLCJCb3hHZW9tZXRyeSIsImlzU3BoZXJlWm9uZSIsImlzTWVzaFpvbmUiLCJjbG9uZSIsIm1hdGVyaWFsIiwiTWVzaEJhc2ljTWF0ZXJpYWwiLCJtZXNoIiwiTWVzaCIsImFkZCIsInBvc2l0aW9uIiwic2V0IiwiZHJhd0VtaXR0ZXIiLCJlbWl0dGVyIiwiT2N0YWhlZHJvbkdlb21ldHJ5IiwiY29weSIsInJvdGF0aW9uIiwicmVuZGVySW5mbyIsImdldENyZWF0ZWROdW1iZXIiLCJ0eXBlIiwicG9vbCIsInJlbmRlcmVyIiwicmVuZGVyZXJzIiwiY0lEIiwiZ2V0RW1pdHRlclBvcyIsImUiLCJlbWl0dGVycyIsIk1hdGgiLCJyb3VuZCIsInAiLCJzdHlsZSIsImFkZEluZm8iLCJzdHIiLCJfaW5mb1R5cGUiLCJsZW5ndGgiLCJuYW1lIiwiZ2V0Q291bnQiLCJfaW5mb0NvbiIsImlubmVySFRNTCIsInNlbGYiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJjc3NUZXh0Iiwiam9pbiIsImJnIiwicGFyZW50Tm9kZSIsImJvZHkiLCJhcHBlbmRDaGlsZCJdLCJtYXBwaW5ncyI6IkFBQUEsU0FBU0EsZ0JBQVQsRUFBMkJDLFlBQVksSUFBSUMsSUFBM0MsUUFBdUQsYUFBdkQ7QUFFQTtBQUNBO0FB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U0FMSCxFQU1FLEtBTkY7O0FBU0EsWUFBSVcsRUFBSixFQUFRekQsS0FBUjs7QUFFQSxnQkFBUTJDLEtBQVI7QUFDRSxlQUFLLENBQUw7QUFDRWMsWUFBQUEsRUFBRSxHQUFHLE1BQUw7QUFDQXpELFlBQUFBLEtBQUssR0FBRyxNQUFSO0FBQ0E7O0FBRUYsZUFBSyxDQUFMO0FBQ0V5RCxZQUFBQSxFQUFFLEdBQUcsTUFBTDtBQUNBekQsWUFBQUEsS0FBSyxHQUFHLE1BQVI7QUFDQTs7QUFFRjtBQUNFeUQsWUFBQUEsRUFBRSxHQUFHLE1BQUw7QUFDQXpELFlBQUFBLEtBQUssR0FBRyxNQUFSO0FBYko7O0FBZ0JBLGFBQUtrRCxRQUFMLENBQWNQLEtBQWQsQ0FBb0Isa0JBQXBCLElBQTBDYyxFQUExQztBQUNBLGFBQUtQLFFBQUwsQ0FBY1AsS0FBZCxDQUFvQixPQUFwQixJQUErQjNDLEtBQS9CO0FBQ0Q7O0FBRUQsVUFBSSxDQUFDLEtBQUtrRCxRQUFMLENBQWNRLFVBQW5CLEVBQStCTCxRQUFRLENBQUNNLElBQVQsQ0FBY0MsV0FBZCxDQUEwQixLQUFLVixRQUEvQjtBQUNoQyxLQTVDRDtBQTZDRCxHQTlDUTtBQWpLSSxDQUFmIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgREVGQVVMVF9QT1NJVElPTiwgREVGQVVMVF9TSVpFIGFzIHNpemUgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5cbi8qKlxuICogQGV4cG9ydHMgRGVidWcgLSBtZXRob2RzIGFuZCBoZWxwZXJzIGZvciBkZWJ1Z2dpbmcgU3lzdGVtIGVtaXR0ZXJzLCB6b25lcyBhbmQgcGFydGljbGVzLlxuICogQHJlcXVpcmVzIFRIUkVFIC0geyBTcGhlcmVHZW9tZXRyeSwgQm94R2VvbWV0cnksIE1lc2hCYXNpY01hdGVyaWFsLCBPY3RhaGVkcm9uR2VvbWV0cnksIE1lc2ggfVxuICovXG5leHBvcnQgZGVmYXVsdCB7XG4gIC8qKlxuICAgKiBBZGRzIGFuIGV2ZW50IGxpc3RlbmVyIHRvIHRoZSBzeXN0ZW0gaW5zdGFuY2UncyBTWVNURU1fVVBEQVRFIGV2ZW50LlxuICAgKlxuICAgKiBAcGFyYW0ge1N5c3RlbX0gc3lzdGVtIC0gdGhlIHN5c3RlbSBpbnN0YW5jZVxuICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBvblN5c3RlbVVwZGF0ZWQgLSB0aGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHN5c3RlbSBoYXMgYmVlbiB1cGRhdGVkXG4gICAqIEByZXR1cm4ge0RlYnVnfVxuICAgKi9cbiAgYWRkRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24oc3lzdGVtLCBvblN5c3RlbVVwZGF0ZWQpIHtcbiAgICBzeXN0ZW0uZXZlbnREaXNwYXRjaGVyLmFkZEV2ZW50TGlzdGVuZXIoJ1NZU1RFTV9VUERBVEUnLCBvblN5c3RlbVVwZGF0ZWQpO1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sXG5cbiAgLyoqXG4gICAqIERyYXdzIGEgd2lyZWZyYW1lIG1lc2ggYXJvdW5kIHRoZSB6b25lIGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMuXG4gICAqXG4gICAqIEBwYXJhbSB7U3lzdGVtfSBzeXN0ZW0gLSB0aGUgc3lzdGVtIGluc3RhbmNlXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBjb250YWluZXIgLSBhIHRocmVlIE9iamVjdDNEICh1c3VhbGx5IHRoZSBzY2VuZSlcbiAgICogQHBhcmFtIHtab25lfSB6b25lIC0gYSBab25lIGluc3RhbmNlXG4gICAqIEByZXR1cm4gdm9pZFxuICAgKi9cbiAgZHJhd1pvbmU6IGZ1bmN0aW9uKFRIUkVFLCBzeXN0ZW0sIGNvbnRhaW5lciwgem9uZSA9IHt9KSB7XG4gICAgY29uc3QgY29sb3IgPSAnIzIxOTRjZSc7XG4gICAgY29uc3Qgd2lyZWZyYW1lID0gdHJ1ZTtcbiAgICBjb25zdCB7XG4gICAgICB3aWR0aCA9IHNpemUsXG4gICAgICBoZWlnaHQgPSBzaXplLFxuICAgICAgZGVwdGggPSBzaXplLFxuICAgICAgcmFkaXVzID0gc2l6ZSxcbiAgICAgIHggPSBERUZBVUxUX1BPU0lUSU9OLFxuICAgICAgeSA9IERFRkFVTFRfUE9TSVRJT04sXG4gICAgICB6ID0gREVGQVVMVF9QT1NJVElPTixcbiAgICB9ID0gem9uZTtcblxuICAgIGxldCBnZW9tZXRyeTtcblxuICAgIGlmICh6b25lLmlzUG9pbnRab25lKCkpIHtcbiAgICAgIGdlb21ldHJ5ID0gbmV3IFRIUkVFLlNwaGVyZUdlb21ldHJ5KDE1KTtcbiAgICB9XG5cbiAgICBpZiAoem9uZS5pc0xpbmVab25lKCkpIHtcbiAgICAgIC8vIFRPRE9cbiAgICB9XG5cbiAgICBpZiAoem9uZS5pc0JveFpvbmUoKSkge1xuICAgICAgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuQm94R2VvbWV0cnkod2lkdGgsIGhlaWdodCwgZGVwdGgpO1xuICAgIH1cblxuICAgIGlmICh6b25lLmlzU3BoZXJlWm9uZSgpKSB7XG4gICAgICBnZW9tZXRyeSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeShyYWRpdXMsIHNpemUsIHNpemUpO1xuICAgIH1cblxuICAgIGlmICh6b25lLmlzTWVzaFpvbmUoKSkge1xuICAgICAgZ2VvbWV0cnkgPSB6b25lLmdlb21ldHJ5Lmdlb21ldHJ5XG4gICAgICAgID8gem9uZS5nZW9tZXRyeS5nZW9tZXRyeS5jbG9uZSgpXG4gICAgICAgIDogem9uZS5nZW9tZXRyeS5jbG9uZSgpO1xuICAgIH1cblxuICAgIGlmICghZ2VvbWV0cnkpIHtcbiAgICAgIGdlb21ldHJ5ID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KHdpZHRoLCBoZWlnaHQsIGRlcHRoKTtcbiAgICB9XG5cbiAgICBjb25zdCBtYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yLCB3aXJlZnJhbWUgfSk7XG4gICAgLy8gTk9URSEgZ2VvbWV0cnkuY2xvbmUgaXMgcmVxdWlyZWQgZm9yIFVOS05PV04gcmVhc29ucyxcbiAgICAvLyB0aHJlZSBkb2VzIG5vdCByZW5kZXIgdGhlIG1lc2ggY29ycmVjdGx5IHdpdGhvdXQgZG9pbmcgdGhpcyBzaW5jZSByODhcbiAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnkuY2xvbmUoKSwgbWF0ZXJpYWwpO1xuXG4gICAgY29udGFpbmVyLmFkZChtZXNoKTtcblxuICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcihzeXN0ZW0sIGZ1bmN0aW9uKCkge1xuICAgICAgbWVzaC5wb3NpdGlvbi5zZXQoeCwgeSwgeik7XG4gICAgfSk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIERyYXdzIGEgbWVzaCBmb3IgZWFjaCBwYXJ0aWNsZSBlbWl0dGVkIGluIG9yZGVyIHRvIGhlbHAgZGVidWcgcGFydGljbGVzLlxuICAgKlxuICAgKiBAcGFyYW0ge29iamVjdH0gc3lzdGVtIC0gdGhlIHN5c3RlbSBpbnN0YW5jZVxuICAgKiBAcGFyYW0ge29iamVjdH0gY29udGFpbmVyIC0gYSB0aHJlZSBPYmplY3QzRCAodXN1YWxseSB0aGUgc2NlbmUpXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBlbWl0dGVyIC0gdGhlIGVtaXR0ZXIgdG8gZGVidWdcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbG9yIC0gdGhlIGNvbG9yIGZvciB0aGUgZGVidWcgbWVzaCBtYXRlcmlhbFxuICAgKiBAcmV0dXJuIHZvaWRcbiAgICovXG4gIGRyYXdFbWl0dGVyOiBmdW5jdGlvbihUSFJFRSwgc3lzdGVtLCBjb250YWluZXIsIGVtaXR0ZXIsIGNvbG9yKSB7XG4gICAgY29uc3QgZ2VvbWV0cnkgPSBuZXcgVEhSRUUuT2N0YWhlZHJvbkdlb21ldHJ5KHNpemUpO1xuICAgIGNvbnN0IG1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHtcbiAgICAgIGNvbG9yOiBjb2xvciB8fCAnI2FhYScsXG4gICAgICB3aXJlZnJhbWU6IHRydWUsXG4gICAgfSk7XG4gICAgLy8gTk9URSEgZ2VvbWV0cnkuY2xvbmUgaXMgcmVxdWlyZWQgZm9yIFVOS05PV04gcmVhc29ucyxcbiAgICAvLyB0aHJlZSBkb2VzIG5vdCByZW5kZXIgdGhlIG1lc2ggY29ycmVjdGx5IHdpdGhvdXQgZG9pbmcgdGhpcyBzaW5jZSByODhcbiAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnkuY2xvbmUoKSwgbWF0ZXJpYWwpO1xuXG4gICAgY29udGFpbmVyLmFkZChtZXNoKTtcblxuICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcihzeXN0ZW0sIGZ1bmN0aW9uKCkge1xuICAgICAgbWVzaC5wb3NpdGlvbi5jb3B5KGVtaXR0ZXIucG9zaXRpb24pO1xuICAgICAgbWVzaC5yb3RhdGlvbi5zZXQoXG4gICAgICAgIGVtaXR0ZXIucm90YXRpb24ueCxcbiAgICAgICAgZW1pdHRlci5yb3RhdGlvbi55LFxuICAgICAgICBlbWl0dGVyLnJvdGF0aW9uLnpcbiAgICAgICk7XG4gICAgfSk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFJlbmRlcnMgZW1pdHRlciAvIHBhcnRpY2xlIGluZm9ybWF0aW9uIGludG8gdGhlIGluZm8gZWxlbWVudC5cbiAgICpcbiAgICogQHBhcmFtIHtvYmplY3R9IHN5c3RlbSAtIHRoZSBzeXN0ZW0gaW5zdGFuY2VcbiAgICogQHBhcmFtIHtpbnRlZ2VyfSBzdHlsZSAtIHN0eWxlIHRvIGFwcGx5IChzZWUgdGhlIGFkZEluZm8gbWV0aG9kJ3Mgc3dpdGNoIHN0YXRlbWVudClcbiAgICogQHJldHVybiB2b2lkXG4gICAqL1xuICByZW5kZXJJbmZvOiAoZnVuY3Rpb24oKSB7XG4gICAgZnVuY3Rpb24gZ2V0Q3JlYXRlZE51bWJlcih0eXBlLCBzeXN0ZW0pIHtcbiAgICAgIHZhciBwb29sID0gdHlwZSA9PSAnbWF0ZXJpYWwnID8gJ19tYXRlcmlhbFBvb2wnIDogJ190YXJnZXRQb29sJztcbiAgICAgIHZhciByZW5kZXJlciA9IHN5c3RlbS5yZW5kZXJlcnNbMF07XG5cbiAgICAgIHJldHVybiByZW5kZXJlcltwb29sXS5jSUQ7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0RW1pdHRlclBvcyhzeXN0ZW0pIHtcbiAgICAgIHZhciBlID0gc3lzdGVtLmVtaXR0ZXJzWzBdO1xuXG4gICAgICByZXR1cm4gKFxuICAgICAgICBNYXRoLnJvdW5kKGUucC54KSArICcsJyArIE1hdGgucm91bmQoZS5wLnkpICsgJywnICsgTWF0aC5yb3VuZChlLnAueilcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZ1bmN0aW9uKHN5c3RlbSwgc3R5bGUpIHtcbiAgICAgIHRoaXMuYWRkSW5mbyhzdHlsZSk7XG4gICAgICB2YXIgc3RyID0gJyc7XG5cbiAgICAgIHN3aXRjaCAodGhpcy5faW5mb1R5cGUpIHtcbiAgICAgICAgY2FzZSAyOlxuICAgICAgICAgIHN0ciArPSAnZW1pdHRlcjonICsgc3lzdGVtLmVtaXR0ZXJzLmxlbmd0aCArICc8YnI+JztcbiAgICAgICAgICBzdHIgKz0gJ2VtIHNwZWVkOicgKyBzeXN0ZW0uZW1pdHRlcnNbMF0uY0lEICsgJzxicj4nO1xuICAgICAgICAgIHN0ciArPSAncG9zOicgKyBnZXRFbWl0dGVyUG9zKHN5c3RlbSk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAzOlxuICAgICAgICAgIHN0ciArPSBzeXN0ZW0ucmVuZGVyZXJzWzBdLm5hbWUgKyAnPGJyPic7XG4gICAgICAgICAgc3RyICs9ICd0YXJnZXQ6JyArIGdldENyZWF0ZWROdW1iZXIoJ3RhcmdldCcpICsgJzxicj4nO1xuICAgICAgICAgIHN0ciArPSAnbWF0ZXJpYWw6JyArIGdldENyZWF0ZWROdW1iZXIoJ21hdGVyaWFsJyk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBzdHIgKz0gJ3BhcnRpY2xlczonICsgc3lzdGVtLmdldENvdW50KCkgKyAnPGJyPic7XG4gICAgICAgICAgc3RyICs9ICdwb29sOicgKyBzeXN0ZW0ucG9vbC5nZXRDb3VudCgpICsgJzxicj4nO1xuICAgICAgICAgIHN0ciArPSAndG90YWw6JyArIChzeXN0ZW0uZ2V0Q291bnQoKSArIHN5c3RlbS5wb29sLmdldENvdW50KCkpO1xuICAgICAgfVxuICAgICAgdGhpcy5faW5mb0Nvbi5pbm5lckhUTUwgPSBzdHI7XG4gICAgfTtcbiAgfSkoKSxcblxuICAvKipcbiAgICogQXBwZW5kcyB0aGUgaW5mbyBlbGVtZW50IGludG8gdGhlIGRvbS5cbiAgICpcbiAgICogQHBhcmFtIHtpbnRlZ2VyfSBzdHlsZSAtIHRoZSBzdHlsZSB0eXBlIHRvIGFwcGx5XG4gICAqIEByZXR1cm4gdm9pZFxuICAgKi9cbiAgYWRkSW5mbzogKGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBmdW5jdGlvbihzdHlsZSkge1xuICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gICAgICBpZiAoIXRoaXMuX2luZm9Db24pIHtcbiAgICAgICAgdGhpcy5faW5mb0NvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICB0aGlzLl9pbmZvQ29uLnN0eWxlLmNzc1RleHQgPSBbXG4gICAgICAgICAgJ3Bvc2l0aW9uOmZpeGVkO2JvdHRvbTowcHg7bGVmdDowO2N1cnNvcjpwb2ludGVyOycsXG4gICAgICAgICAgJ29wYWNpdHk6MC45O3otaW5kZXg6MTAwMDA7cGFkZGluZzoxMHB4O2ZvbnQtc2l6ZToxMnB4OycsXG4gICAgICAgICAgJ3dpZHRoOjEyMHB4O2hlaWdodDo1MHB4O2JhY2tncm91bmQtY29sb3I6IzAwMjtjb2xvcjojMGZmOycsXG4gICAgICAgIF0uam9pbignJyk7XG5cbiAgICAgICAgdGhpcy5faW5mb1R5cGUgPSAxO1xuICAgICAgICB0aGlzLl9pbmZvQ29uLmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAgICAgJ2NsaWNrJyxcbiAgICAgICAgICBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHNlbGYuX2luZm9UeXBlKys7XG4gICAgICAgICAgICBpZiAoc2VsZi5faW5mb1R5cGUgPiAzKSBzZWxmLl9pbmZvVHlwZSA9IDE7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBmYWxzZVxuICAgICAgICApO1xuXG4gICAgICAgIHZhciBiZywgY29sb3I7XG5cbiAgICAgICAgc3dpdGNoIChzdHlsZSkge1xuICAgICAgICAgIGNhc2UgMjpcbiAgICAgICAgICAgIGJnID0gJyMyMDEnO1xuICAgICAgICAgICAgY29sb3IgPSAnI2YwOCc7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgIGNhc2UgMzpcbiAgICAgICAgICAgIGJnID0gJyMwMjAnO1xuICAgICAgICAgICAgY29sb3IgPSAnIzBmMCc7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICBiZyA9ICcjMDAyJztcbiAgICAgICAgICAgIGNvbG9yID0gJyMwZmYnO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5faW5mb0Nvbi5zdHlsZVsnYmFja2dyb3VuZC1jb2xvciddID0gYmc7XG4gICAgICAgIHRoaXMuX2luZm9Db24uc3R5bGVbJ2NvbG9yJ10gPSBjb2xvcjtcbiAgICAgIH1cblxuICAgICAgaWYgKCF0aGlzLl9pbmZvQ29uLnBhcmVudE5vZGUpIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5faW5mb0Nvbik7XG4gICAgfTtcbiAgfSkoKSxcbn07XG4iXX0=